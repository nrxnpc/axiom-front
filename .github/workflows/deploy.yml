name: Deploy React App

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
    
    - name: Install dependencies
      run: yarn install --frozen-lockfile
    
    - name: Build project
      run: yarn build
    
    - name: Verify build
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ ==="
        ls -la dist/
        echo ""
        echo "–ü–µ—Ä–≤—ã–π HTML:"
        head -3 dist/index.html
    
    - name: Deploy to server
      uses: easingthemes/ssh-deploy@v4
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
        REMOTE_USER: ${{ secrets.REMOTE_USER }}
        SOURCE: "dist/"
        TARGET: "/var/www/nsp-frontend/html/"         
        ARGS: "-rltgoDzvO --delete"
        SCRIPT_BEFORE: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ $(date)"
          echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"
          echo "–¶–µ–ª–µ–≤–∞—è –ø–∞–ø–∫–∞: /var/www/nsp-frontend/html"
          
        SCRIPT_AFTER: |
          echo ""
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω –≤ $(date)"
          echo ""
          echo "=== –§–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ==="
          ls -la /var/www/nsp-frontend/html/
          echo ""
          echo "=== –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx ==="
          sudo systemctl reload nginx